---
- name: Link shared .env
  file:
    src: "{{ shared_path }}/.env"
    dest: "{{ releases_path }}/{{ release_name }}/.env"
    state: link

- name: Link storage
  file:
    src: "{{ shared_path }}/storage"
    dest: "{{ releases_path }}/{{ release_name }}/storage"
    state: link
    force: yes

- name: Install composer dependencies
  command: >
    composer install
    --no-dev
    --no-interaction
    --prefer-dist
    --optimize-autoloader
  args:
    chdir: "{{ releases_path }}/{{ release_name }}"
  environment:
    COMPOSER_ALLOW_SUPERUSER: "1"

- name: Ensure bootstrap/cache directory exists
  file:
    path: "{{ releases_path }}/{{ release_name }}/bootstrap/cache"
    state: directory
    mode: '0775'

- name: Clear Laravel optimization caches
  command: php artisan optimize:clear
  args:
    chdir: "{{ releases_path }}/{{ release_name }}"
  failed_when: false

- name: Cache config
  command: php artisan config:cache
  args:
    chdir: "{{ releases_path }}/{{ release_name }}"

- name: Cache routes
  command: php artisan route:cache
  args:
    chdir: "{{ releases_path }}/{{ release_name }}"

- name: Cache views
  command: php artisan view:cache
  args:
    chdir: "{{ releases_path }}/{{ release_name }}"

- name: Run migrations
  command: php artisan migrate --force
  args:
    chdir: "{{ releases_path }}/{{ release_name }}"

- name: Set proper permissions
  file:
    path: "{{ item }}"
    state: directory
    mode: '0775'
    recurse: yes
  loop:
    - "{{ releases_path }}/{{ release_name }}/bootstrap/cache"
  when: item is exists