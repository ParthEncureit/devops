---
# 1️⃣ Wait for app to stabilize
- name: Wait for web server to be reachable
  wait_for:
    host: "{{ ansible_host }}"
    port: 80
    timeout: 30

# 2️⃣ Check HTTP accessibility
- name: Check application is accessible
  uri:
    url: "http://{{ ansible_host }}/"
    method: GET
    status_code: 200
    timeout: 10
  register: http_check
  retries: 3
  delay: 5
  until: http_check.status == 200

# 3️⃣ Check application health (Laravel + DB + env)
- name: Check application health endpoint
  uri:
    url: "http://{{ ansible_host }}/api/health"
    method: GET
    status_code: 200
    return_content: yes
    timeout: 10
  register: health_check
  retries: 5
  delay: 5
  until: health_check.status == 200

- name: Display health check details
  debug:
    msg:
      - "========================================="
      - "HEALTH CHECK RESULTS"
      - "========================================="
      - "HTTP Status: {{ http_check.status | default('N/A') }}"
      - "Health Endpoint Status: {{ health_check.status | default('N/A') }}"
      - "Health Response:"
      - "{{ health_check.content | default('No response body') }}"
      - "========================================="
  when: health_check is failed or http_check is failed
